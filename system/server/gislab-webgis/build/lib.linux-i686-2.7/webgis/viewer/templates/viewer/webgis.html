{% load staticfiles %}

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

		<link rel="icon" type="image/png" href="{% static 'viewer/images/webgis16.png' %}"/>
		<link rel="stylesheet" type="text/css" href="{% static 'viewer/lib/ext-3.4.1/resources/css/ext-all.css' %}"/>
		<link rel="stylesheet" type="text/css" href="{% static 'viewer/webgis.css' %}"/>

		<script type="text/javascript" src="{% static 'viewer/lib/ext-3.4.1/adapter/ext/ext-base.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/lib/ext-3.4.1/ext-all.js' %}"></script>
		{% if debug %}
		<script type="text/javascript" src="{% static 'viewer/lib/OpenLayers-2.13/OpenLayers.debug.js' %}"></script>
		{% else %}
		<script type="text/javascript" src="{% static 'viewer/lib/OpenLayers-2.13/OpenLayers.js' %}"></script>
		{% endif %}
		<script type="text/javascript" src="{% static 'viewer/lib/GeoExt-1.1/GeoExt.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/js/featureinfo_panel.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/js/draw_action.js' %}"></script>
		<script type="text/javascript" src="{% static 'viewer/js/control_display.js' %}"></script>
		{% if google %}<script type="text/javascript" src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>{% endif %}

		<title id="page-title">{{ root_title }}</title>
		
		{% comment %} ##  CONFIGURATION  ## {% endcomment %}
		<script type="text/javascript">
			function main() {

				Ext.BLANK_IMAGE_URL = "{% static 'viewer/images/s.gif' %}";
				OpenLayers.DOTS_PER_INCH = {{ dpi }};
				//OpenLayers.ProxyHost = "/proxy/?url=";
				var config = {
					projection: "{{ projection }}",
					units: "{{ units }}",
					maxExtent: [{{ project_extent }}],
				};

				var layer = null;
				var vector_data_balls = null;
				var zoom_extent = OpenLayers.Bounds.fromString('{{ zoom_extent }}');
				{% if tile_resolutions %}config.tile_resolutions = [{{ tile_resolutions }}];{% endif %}

				{% if debug %}{% autoescape off %}console.log("CONFIG: {{ config }}");{% endautoescape %}{% endif %}

				// ###  LAYERS  ###
				var maplayers = [];

				// base layers
				{% if google %}
				maplayers.push(new OpenLayers.Layer.Google('Google {{ google.title }}',
					{type: google.maps.MapTypeId.{{ google }},
					mapTypeId: '{{ google }}'}));
				{% endif %}
				// seems that must be loaded after google layer
				{% if osm %}maplayers.push(new OpenLayers.Layer.OSM());{% endif %}

				// overlay layers
				{% if layers %}
				var overlays_group_layer = new OpenLayers.Layer.WMS(
					"OverlaysGroup",
					["{{ ows_url }}&DPI={{ dpi }}&TRANSPARENT=TRUE"],
					{
						layers: ["{{ layers|join:'", "' }}"],
						transparent: true,
						format: "image/png",
					},
					{
						gutter: 0,
						isBaseLayer: false,
						buffer: 0,
						visibility: true,
						singleTile: true,
						// attribution: "",
					}
				);
				{% else %}
				var overlays_group_layer = new OpenLayers.Layer('Empty');
				{% endif %}
				maplayers.push(overlays_group_layer);

				// drawing layers
				var vector_style = {
					styleMap: new OpenLayers.StyleMap({
						'default':{
							label: '${label}',
							fontSize: '12px',
							fontWeight: 'bold',
							labelAlign: 'lb',
							strokeColor: '#AA0000',
							strokeOpacity: 1,
							strokeWidth: 1.5,
							fillColor: '#FF0000',
							fillOpacity: 0.5,
							pointRadius: 6,
							labelYOffset: '6',
							labelXOffset: '6',
							fontColor: '#AA0000',
							labelOutlineColor: 'white',
							labelOutlineWidth: 2.5,
							labelOutlineOpacity: 0.5,
						},
						'select': {
							label: '${label}',
							fontSize: '12px',
							fontWeight: 'bold',
							labelAlign: 'lb',
							strokeColor: '#66CCCC',
							strokeOpacity: 1,
							strokeWidth: 1.5,
							fillColor: '#66CCCC',
							fillOpacity: 0.3,
							pointRadius: 6,
							labelYOffset: '6',
							labelXOffset: '6',
							fontColor: '#306060',
							labelOutlineColor: 'white',
							labelOutlineWidth: 2.5,
							labelOutlineOpacity: 0.5,
						},
						'modify': {
							label: '',
							fillColor: '#66CCCC',
							fillOpacity: 0.3,
							strokeColor: '#66CCCC',
							strokeOpacity: 1,
							strokeWidth: 2,
						}
					})
				};
				var points_layer = new OpenLayers.Layer.Vector('POINTS', vector_style);
				var lines_layer = new OpenLayers.Layer.Vector('LINES', vector_style);
				var polygons_layer = new OpenLayers.Layer.Vector('POLYGON', vector_style);
				maplayers.push(points_layer);
				maplayers.push(lines_layer);
				maplayers.push(polygons_layer);

				// map panel
				var mappanel = new GeoExt.MapPanel({
					region: 'center',
					title: '{{ root_title }}',
					collapsible: false,
					zoom: 3,
					map: {
						allOverlays: {% if osm or google %}false{% else %}true{% endif %},
						units: config.units,
						projection: new OpenLayers.Projection(config.projection),
						resolutions: config.tile_resolutions,
						maxExtent: new OpenLayers.Bounds(config.maxExtent[0], config.maxExtent[1],
							config.maxExtent[2], config.maxExtent[3]),
						controls: []
					},
					layers: maplayers,
					items: [{
						xtype: "gx_zoomslider",
						aggressive: true,
						vertical: true,
						height: 150,
						x: 17,
						y: 85,
						plugins: new GeoExt.ZoomSliderTip()
					}],
					tbar: [],
					bbar: [],
					stateId: 'map',
				});
				var mappanel_container = mappanel;


				var ctrl, action;
				{% if featureinfo %}
				//featureinfo panel
				var featureinfo_panel = new WebGIS.FeatureInfoPanel({
					id: 'featureinfo-panel',
					title: 'Attributes',
					map: mappanel.map,
					//autoPanMapOnSelection: true,
					collapsible: true,
					collapsed: true,
					height: 120,
					split: true,
					region: 'south',
					animate: false,
				});

				var mappanel_container = new Ext.Panel({
					layout: 'border',
					region: 'center',
					items: [
						mappanel,
						featureinfo_panel
					]
				});
				{% endif %}

				// Toolbar Actions

				{% if featureinfo %}
				{% include "viewer/actions/featureinfo.js" %}
				{% endif %}

				{% include "viewer/actions/basic.js" %}
				{% include "viewer/actions/measurement.js" %}
				{% include "viewer/actions/draw.js" %}
				{% include "viewer/actions/save.js" %}

				// tree node
				var layers_root = new Ext.tree.TreeNode({
					text: 'Layers',
					expanded: true,
					draggable: false
				});

				//# base layers tree
				{% if osm or google %}
				layers_root.appendChild(new GeoExt.tree.BaseLayerContainer({
					text: 'Base Layers',
					map: mappanel.map,
					leaf: false,
					expanded: true,
					draggable: false,
					isTarget: false,
					split: true
				}));
				{% endif %}

				// overlay layers tree
				layers_root.appendChild(new GeoExt.tree.LayerNode({
					text: 'Overlays',
					layer: overlays_group_layer,
					leaf: false,
					expanded: true,
					allowDrag: false,
					loader: {
						param: "LAYERS"
					}
				}));

				// layers tree
				var layer_treepanel = new Ext.tree.TreePanel({
					title: 'Content',
					enableDD: false,
					root: layers_root,
					split: true,
					border: true,
					collapsible: false,
					cmargins: '0 0 0 0',
					autoScroll: true
				});

				// legend
				var layer_legend = new GeoExt.LegendPanel({
					title: 'Legend',
					map: mappanel.map,
					border: false,
					ascending: false,
					autoScroll: true,
					filter: function(record) {
						var title = record.data.title;
						if (title == points_layer.name || title == lines_layer.name || title == polygons_layer.name) {
							return false;
						}
						return true;
					},
					defaults: {
						cls: 'legend-item',
						baseParams: {
							FORMAT: 'image/png',
							SYMBOLHEIGHT: '2',
							SYMBOLWIDTH: '4',
							LAYERFONTSIZE: '8',
							LAYERFONTBOLD: 'true',
							ITEMFONTSIZE: '8',
							ICONLABELSPACE: '15'
						}
					}
				});

				// properties
				var properties = new Ext.Panel({
					title: 'Project',
					autoScroll: true,
					html: '<div class="x-panel-body-text"><p><b>Author: </b>{{ author }}</p><p><b>E-mail: </b>{{ email }}</p><p><b>Organization: </b>{{ organization }}</p><b>Abstract: </b>{{ abstract }}</p></div>'
				});

				// legend and properties accordion panel
				var accordion = new Ext.Panel({
					layout: {
						type: 'accordion',
						titleCollapse: true,
						animate: false,
						activeOnTop: false
					},
					items: [
						layer_legend,
						properties
					]
				});

				// left panel
				var left_panel = new Ext.Panel({
					region: 'west',
					width: 200,
					defaults: {
						width: '100%',
						flex: 1
					},
					layout: 'vbox',
					collapsible: true,
					layoutConfig: {
						align: 'stretch',
						pack: 'start'
					},
					items: [
						layer_treepanel,
						accordion
					]
				});

				// viewport
				var webgis = new Ext.Viewport({
					layout: "border",
					items: [
						mappanel_container,
						left_panel
					]
				});

				{% if visible_layers %}
				// set visible layers
					{% for layer_name in layers %}
						{% if layer_name not in visible_layers %}
				layers_root.findChild('text', '{{ layer_name }}', true).ui.toggleCheck(false);
						{% endif %}
					{% endfor %}
				{% endif %}

				// controls
				var coords = new GeoExt.Toolbar.ControlDisplay({control: new OpenLayers.Control.MousePosition({separator: ' , '}), map: mappanel.map});

				mappanel.getBottomToolbar().add(new Ext.Toolbar.TextItem({text: config.projection}));
				mappanel.getBottomToolbar().add(' ', '-', '');
				mappanel.getBottomToolbar().add(coords);
				var measurement_output = new Ext.Toolbar.TextItem({
					id:'measurement-info',
					text: ''
				});
				mappanel.getBottomToolbar().add(' ', '-', ' ', measurement_output);

				mappanel.map.zoomToExtent(zoom_extent, true);
				mappanel.map.addControl(new OpenLayers.Control.Scale());
				mappanel.map.addControl(new OpenLayers.Control.ScaleLine());
				mappanel.map.addControl(new OpenLayers.Control.PanPanel());
				mappanel.map.addControl(new OpenLayers.Control.ZoomPanel());
				mappanel.map.addControl(new OpenLayers.Control.Navigation());
				mappanel.map.addControl(new OpenLayers.Control.Attribution());
				map = mappanel.map;

				// insert points from GET parameter
				{% if balls %}
					vector_data_balls = '{{ balls|join:"," }}';
					{% for ball in balls %}
						Ext.Ajax.request({
							method: 'GET',
							url: '{% url "webgis.storage.views.ball" %}',//'/proxy/?url=' + encodeURIComponent('http://balls.gis.lab/?ID={{ ball }}'),
							params: {
								ID: '{{ ball }}'
							},
							success: function(response) {
								var features = new OpenLayers.Format.GeoJSON().read(response.responseText);
								var points = [];
								var lines = [];
								var polygons = [];
								Ext.each(features, function(f) {
									if (f.geometry.CLASS_NAME == 'OpenLayers.Geometry.Point')
										points.push(f);
									if (f.geometry.CLASS_NAME == 'OpenLayers.Geometry.LineString')
										lines.push(f);
									if (f.geometry.CLASS_NAME == 'OpenLayers.Geometry.Polygon')
										polygons.push(f);
								});
								points_layer.addFeatures(points);
								lines_layer.addFeatures(lines);
								polygons_layer.addFeatures(polygons);
							},
							failure: function(response, opts) {
								Ext.MessageBox.alert("Error", "Failed to fetch vector data (ball: {0})");
							}
						});
					{% endfor %}
				{% endif %}

				{% include "viewer/permalink.js" %}
			}; // end of main function

			Ext.QuickTips.init();
			Ext.onReady(main);
		</script>
	</head>
	<body>
		<div id="overviewLegend" style="margin-left:10px"></div>
		<div id="dpiDetection"></div>
	</body>
</html>
